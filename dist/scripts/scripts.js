"use strict";angular.module("axisJSApp",["ngAnimate","ngResource","ngSanitize","ui","ui.router","ui.bootstrap","minicolors","cn.offCanvas"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("index",{url:"/",templateUrl:"partials/main.html",controller:"MainCtrl",resolve:{appConfig:["configProvider","$rootScope",function(a,b){return b.version="0.2.3",a}]}})}]),angular.module("axisJSApp").factory("configChooser",["cnOffCanvas",function(a){return a({controller:function(){this.name="Choose Configuration"},controllerAs:"ConfigCtrl",templateUrl:"partials/configChooser.html"})}]),angular.module("axisJSApp").provider("configProvider",function(){var a="config.yaml";return{setConfigFile:function(b){a=b},$get:["$http","$q",function(b,c){var d=b.get("default.config.yaml"),e=b.get(a).then(function(a){return a.data},function(a){return 404===a.status?(a.data={},a):c.reject(a)});return c.all([d,e]).then(function(a){var b=jsyaml.safeLoad(a[0].data),c=jsyaml.safeLoad(a[1]);return c="undefined"!==c?c:{},angular.extend(b,c)})}]}}).config(["configProviderProvider",function(a){var b=window.location.href.match(/config=([a-z]+)/i);b&&b.length>0&&a.setConfigFile("themes/"+b[1]+".config.yaml")}]),angular.module("axisJSApp").controller("MainCtrl",["chartProvider","configChooser","appConfig","$scope",function(a,b,c,d){d.appConfig=c,d.appConfig.toggleChooser=b.toggle,d.inputs={},d.columns=[],d.chartData={},d.config=a(c).config,d.chartTypes=a(c).chartTypes,d.axesConfig=a(c).axesConfig,d.inputs.csvData="data1	data2\n30	50\n200	20\n100	10\n400	40\n150	15\n250	25",d.config.background=!1,d.config.backgroundColor=d.appConfig.backgroundColor?d.appConfig.backgroundColor:"white",d.updateData=function(){if(d.inputs.csvData){d.chartData=[],d.columns=[],d.config.data.columns=[];var a={header:!0};d.inputs.csvData.match("	")&&(a.delimiter="	"),d.chartData=Papa.parse(d.inputs.csvData,a).data,d.chartData.length>0&&(d.columns=Object.keys(d.chartData[0]),angular.forEach(d.columns,function(a){var b=[];b.push(a),angular.forEach(d.chartData,function(c){b.push(c[a])}),d.config.data.columns.push(b),"undefined"==typeof d.config.data.types[a]&&(d.config.data.types[a]="series"===d.config.chartGlobalType?"line":d.config.chartGlobalType)}))}},d.validateCSV=function(a){var b={header:!0};a.match("	")&&(b.delimiter="	");var c=Papa.parse(a,b),d=/^[^,\t\s]*\n[^,\t\s]*$/gm;return c.errors.length>0&&!a.match(d)?!1:!0},d.setGlobalType=function(a){for(var b in d.config.data.types)d.config.data.types.hasOwnProperty(b)&&(d.config.data.types[b]="series"!==a?a:"line")},d.setGroups=function(){d.config.data.groups=[];for(var a in d.config.groups)d.config.groups.hasOwnProperty(a)&&("undefined"==typeof d.config.data.groups[d.config.groups[a]]&&(d.config.data.groups[d.config.groups[a]]=[]),d.config.data.groups[d.config.groups[a]].push(a))},d.updateData(),window.getConfig=function(){console.dir(d.config),window.chartConfig=d.config},"undefined"!=typeof parent.tinymce&&"undefined"!=typeof parent.tinymce.activeEditor.windowManager.getParams().axisJS&&(d.config=angular.fromJson(window.atob(parent.tinymce.activeEditor.windowManager.getParams().axisJS)),d.config.axis.x.tick.format=function(a){return"series"===d.config.chartGlobalType&&"category"!==d.config.axis.x.type?d.config.axis.x.prefix+a.toFixed(d.config.axis.x.accuracy).toString()+d.config.axis.x.suffix:a},d.config.axis.y.tick.format=function(a){return"series"===d.config.chartGlobalType&&"category"!==d.config.axis.y.type?d.config.axis.y.prefix+a.toFixed(d.config.axis.y.accuracy).toString()+d.config.axis.y.suffix:a},d.config.axis.y2.tick.format=function(a){return"series"===d.config.chartGlobalType&&"category"!==d.config.axis.y2.type?d.config.axis.y2.prefix+a.toFixed(d.config.axis.y2.accuracy).toString()+d.config.axis.y2.suffix:a},d.config.donut.label.format=function(a,b){return(100*b).toFixed(d.config.chartAccuracy)+"%"},d.config.pie.label.format=function(a,b){return(100*b).toFixed(d.config.chartAccuracy)+"%"},d.config.gauge.label.format=function(a,b){return(100*b).toFixed(d.config.chartAccuracy)+"%"},d.updateData())}]),angular.module("axisJSApp").directive("buildChart",["chartProvider","$timeout",function(a,b){return{restrict:"A",link:function(c,d){function e(){var a,b,d,e,f=d3.select("svg"),g=f.attr("width");null!==f.select("text.titles")[0][0]?(a=f.select("text.titles"),b=a.select("tspan.chartTitle"),d=a.select("tspan.chartCredit"),e=a.select("tspan.chartSource")):(a=f.insert("text").attr("class","titles").attr("text-anchor",c.appConfig.titles.align),b=a.insert("tspan").attr("class","chartTitle"),d=a.insert("tspan").attr("class","chartCredit"),e=a.insert("tspan").attr("class","chartSource")),b.text(c.config.chartTitle).attr("font-size",c.appConfig.titles["title size"]),d.text(c.config.chartCredit).attr("font-size",c.appConfig.titles["credit size"]);var h=(c.appConfig.titles["append source"]&&c.config.chartSource?"Source: ":"")+c.config.chartSource;e.text(h).attr({"font-size":c.appConfig.titles["source size"],"font-style":c.appConfig.titles["source style"]});var i="undefined"!=typeof c.appConfig.titles["title translateY"]?c.appConfig.titles["title translateY"]:0;b.attr({dy:i,x:0});var j="undefined"!=typeof c.appConfig.titles["credit translateY"]?c.appConfig.titles["credit translateY"]:32;d.attr({dy:j,x:0});var k="undefined"!=typeof c.appConfig.titles["source translateY"]?c.appConfig.titles["source translateY"]:30;for(e.attr({dy:k,x:0});b.node().getComputedTextLength()>g||d.node().getComputedTextLength()>g||e.node().getComputedTextLength()>g;){var l=parseInt(b.attr("font-size").replace("px",""))-1,m=parseInt(d.attr("font-size").replace("px",""))-1,n=parseInt(e.attr("font-size").replace("px",""))-1;b.attr("font-size",l+"px"),d.attr("font-size",m+"px"),e.attr("font-size",n+"px"),d.attr({dy:l,x:0}),e.attr({dy:m,x:0})}if(c.appConfig.titles["title background"]&&b.text().length>0){b.attr("fill","white");var o=b.node().getBBox(),p=c.appConfig.titles["background padding"],q=d3.select(b.node().parentNode.parentNode).insert("rect","text.titles");q.attr("x",0).attr("y",0).attr("class","title-background").attr("width",o.width+2*p).attr("height",18+2*p).style("fill",c.config.data.colors[c.config.data.columns[0][0]]),b.attr({x:0+p,dy:i+p})}var r="undefined"!=typeof c.appConfig.titles.translateX?c.appConfig.titles.translateX:g/2,s="undefined"!=typeof c.appConfig.titles.translateY?c.appConfig.titles.translateY:350;a.attr("width",g).attr("transform","translate("+r+","+s+")"),f.attr("height",f.node().getBBox().height+"px")}function f(){g=a(c.appConfig).generate(d[0].id,c.config),b(function(){e()})}d.children("svg").attr("transform","scale(2)");var g;f(),c.$watch("config.data.columns",function(){f();for(var a in g.data.colors())c.config.data.colors[a]=g.data.colors()[a]}),c.$watch("config.data.colors",function(){g.data.colors(c.config.data.colors)},!0),c.$watch("config.data.types",function(){f()},!0),c.$watch("config.axis",function(a){for(var b in a)if(a.hasOwnProperty(b)){if(a[b].hasOwnProperty("label")){var d={};d[b]=a[b].label,g.axis.labels(d)}(a[b].hasOwnProperty("show")||a[b].hasOwnProperty("max")||a[b].hasOwnProperty("min"))&&f(),(a[b].hasOwnProperty("prefix")||a[b].hasOwnProperty("suffix")||a[b].hasOwnProperty("accuracy"))&&(c.config.axis[b].prefix="undefined"==typeof a[b].prefix?"":a[b].prefix,c.config.axis[b].suffix="undefined"==typeof a[b].suffix?"":a[b].suffix,c.config.axis[b].accuracy="undefined"==typeof a[b].accuracy?0:a[b].accuracy)}},!0),c.$watchGroup(["config.data.x","config.data.y","config.data.y2"],function(a){a.forEach(function(a,b){var d=0===b?"x":1===b?"y":2===b?"y2":"";c.config.data.columns.forEach(function(b){for(var e=1;e<b.length;e++){if(isNaN(b[e])&&b[0]===a){c.config.axis[d].type="category",c.config.axis[d].tick=void 0;break}b[0]===a&&(c.config.data.axes[a]=d)}})}),f()}),c.$watchGroup(["config.chartTitle","config.chartCredit","config.chartSource","config.chartAccuracy","config.legend.position","config.legend.show"],function(){f()}),c.$watch("config.data.groups",function(){f()},!0),c.$watch("config.background",function(a){a===!0?d3.select("svg").insert("rect",":first-child").attr("class","chart-bg").attr("width","100%").attr("height","100%").attr("fill",c.config.backgroundColor):d3.select(".chart-bg").remove()})}}}]),angular.module("axisJSApp").directive("exportChart",["outputService","embedOutput",function(a,b){return{restrict:"A",link:function(c,d,e){d.on("click",function(){switch(e.exportChart){case"cms":g(c.config.chartWidth),a(c,"export");break;case"embed":g(c.config.chartWidth),b.export(c);break;case"images":g(c.config.chartWidth)}});var f,g=function(a){angular.element("defs").remove(),h();var b=angular.element("#canvas").empty()[0];if(a){var d=a/angular.element("#chart").width();angular.element("#chart > svg").attr("transform","scale("+d+")"),b.width=angular.element("#chart > svg").width()*d,b.height=angular.element("#chart > svg").height()*d}else angular.element("#chart > svg").attr("transform","scale(2)"),b.width=2*angular.element("#chart > svg").width(),b.height=2*angular.element("#chart > svg").height();var e=b.getContext("2d"),f=document.getElementsByTagName("svg")[0],g=new XMLSerializer;f=g.serializeToString(f),e.drawSvg(f,0,0);for(var i=[],k=0;k<c.columns.length;k++)i.push(c.columns[k]);c.chartTitle&&i.unshift(c.chartTitle),i=i.join("-").replace(/[^\w\d]+/gi,"-"),angular.element(".savePNG").attr("href",b.toDataURL("png")).attr("download",function(){return i+"_axisJS.png"});var l=j(angular.element("#chart > svg")[0]);$(".saveSVG").attr("href","data:text/svg,"+l.source[0]).attr("download",function(){return i+"_axisJS.svg"})},h=function(){for(var a,b,c=0;c<=document.styleSheets.length-1;c++)document.styleSheets[c].href&&-1!==document.styleSheets[c].href.indexOf("c3.css")&&(a=void 0!==document.styleSheets[c].rules?document.styleSheets[c].rules:document.styleSheets[c].cssRules);if(null!==a&&void 0!==a){var d=function(){("hidden"===angular.element(this).css("visibility")||"0"===angular.element(this).css("opacity"))&&angular.element(this).css("display","none")};for(c=0;c<a.length;c++)1===a[c].type&&(b=a[c].selectorText,f=i(a[c]),angular.element("svg *").each(d),angular.element(b).not(".c3-chart path").css(f)),angular.element(".c3-chart path").filter(function(){return"none"===angular.element(this).css("fill")}).attr("fill","none"),angular.element(".c3-chart path").filter(function(){return"none"!==angular.element(this).css("fill")}).attr("fill",function(){return angular.element(this).css("fill")})}},i=function(a){var b,c=a.style,d={};for(b=0;b<c.length;b++)d[c[b]]=c[c[b]];return d},j=function(a){var b={xmlns:"http://www.w3.org/2000/xmlns/",xlink:"http://www.w3.org/1999/xlink",svg:"http://www.w3.org/2000/svg"},c='<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">';a.setAttribute("version","1.1");var d=document.createElement("style");d.setAttribute("type","text/css"),a.removeAttribute("xmlns"),a.removeAttribute("xlink"),a.hasAttributeNS(b.xmlns,"xmlns")||a.setAttributeNS(b.xmlns,"xmlns",b.svg),a.hasAttributeNS(b.xmlns,"xmlns:xlink")||a.setAttributeNS(b.xmlns,"xmlns:xlink",b.xlink);var e=(new XMLSerializer).serializeToString(a).replace("</style>","<![CDATA["+f+"]]></style>");return e=e.replace(/\sfont-.*?: .*?;/gi,""),e=e.replace(/\sclip-.*?="url\(http:\/\/.*?\)"/gi,""),e=e.replace(/\stransform="scale\(2\)"/gi,""),e=e.replace(/<defs xmlns="http:\/\/www.w3.org\/1999\/xhtml">/gi,"<defs>"),{svg:a,source:[c+e]}}}}}]),angular.module("axisJSApp").directive("addColors",["$timeout",function(a){return{restrict:"A",link:function(b,c){a(function(){c.children("option").each(function(){var a=angular.element(this);a.attr("data-color",a.text())}),c.colorselector()},500)}}}]),angular.module("axisJSApp").factory("GenericOutput",[function(){return this.serviceConfig={type:"save",label:""},this.preprocess=function(a){return a},this.process=function(a){return a},this.complete=function(a){console.log(a)},this.export=function(a){var b=this.preprocess(a),c=this.process(b);this.complete(c)},this}]),angular.module("axisJSApp").factory("WordPressOutput",["GenericOutput",function(a){var b=angular.copy(a);return b.serviceConfig={type:"export",label:"Save to WordPress"},b.preprocess=function(a){var b=a.config;b.axis.x.tick.format=b.axis.x.tick.format.toString(),b.axis.y.tick.format=b.axis.y.tick.format.toString(),b.axis.y2.tick.format=b.axis.y2.tick.format.toString(),b.pie.label.format=b.pie.label.format.toString(),b.donut.label.format=b.donut.label.format.toString(),b.gauge.label.format=b.gauge.label.format.toString();var c=String(angular.toJson(b)),d=String(angular.element(".savePNG").attr("href")),e=parent.tinymce.activeEditor.windowManager.getParams().axisWP;return{action:"insert_axis_attachment",axisConfig:c,axisChart:d,parentID:e.parentID}},b.process=function(a){$.post(parent.ajaxurl,a,function(a){a=angular.fromJson(a),parent.tinymce.activeEditor.insertContent('<div class="mceNonEditable"><img src="'+a.attachmentURL+"\" data-axisjs='"+window.btoa(angular.toJson(a))+'\' class="mceItem axisChart" /></div><br />'),parent.tinymce.activeEditor.windowManager.close()})},b.complete=function(){console.log("Complete.")},b.export=function(a){var c=b.preprocess(a);b.process(c),b.complete()},b}]),angular.module("axisJSApp").service("outputService",["configProvider","$injector",function(a,b){return function(a,c){var d=a.appConfig;angular.forEach(d[c],function(c){var d=b.get(c+"Output");d.export(a)})}}]),angular.module("axisJSApp").service("chartProvider",["$injector",function(a){return function(b){var c=a.get(b.framework+"Service"),d=c.getConfig(b);return d.generate=c.generate,d}}]),angular.module("axisJSApp").factory("c3Service",function(){return{generate:function(a,b){var c=angular.extend({bindto:"#"+a},b);return c3.generate(c)},getConfig:function(a){var b=[];angular.forEach(a.colors,function(a){b.push(a.value)});var c={data:{x:"",y:"",y2:"",columns:[["data1",30,200,100,400,150,250],["data2",50,20,10,40,15,25]],axes:{},groups:{},type:"",types:{data1:"line",data2:"line"},colors:{data1:a.colors[0].value,data2:a.colors[1].value}},grid:{x:{show:"undefined"!=typeof a.defaults["grid x"]?a.defaults["grid x"]:!1},y:{show:"undefined"!=typeof a.defaults["grid y"]?a.defaults["grid y"]:!1}},axis:{x:{show:"undefined"!=typeof a.defaults["axis x"]?a.defaults["axis x"]:!0},y:{show:"undefined"!=typeof a.defaults["axis y"]?a.defaults["axis y"]:!0},y2:{show:"undefined"!=typeof a.defaults["axis y2"]?a.defaults["axis y2"]:!1}},point:{show:"undefined"!=typeof a.defaults.point?a.defaults.point:!1},legend:{position:"undefined"!=typeof a.defaults["legend position"]?a.defaults["legend position"]:"bottom",show:"undefined"!=typeof a.defaults.legend?a.defaults.legend:!0},color:{pattern:b}},d=["line","step","area","area-step","scatter","bar","spline"],e=[{value:"x",label:"Bottom"},{value:"y",label:"Left"},{value:"y2",label:"Right"}];return c.groups={},c.axis.x.accuracy=0,c.axis.y.accuracy=0,c.axis.y2.accuracy=0,c.axis.x.prefix="",c.axis.y.prefix="",c.axis.y2.prefix="",c.axis.x.suffix="",c.axis.y.suffix="",c.axis.y2.suffix="",c.axis.x.tick={format:function(a){return"series"===c.chartGlobalType&&"category"!==c.axis.x.type?c.axis.x.prefix+a.toFixed(c.axis.x.accuracy).toString()+c.axis.x.suffix:a}},c.axis.y.tick={format:function(a){return"series"===c.chartGlobalType&&"category"!==c.axis.y.type?c.axis.y.prefix+a.toFixed(c.axis.y.accuracy).toString()+c.axis.y.suffix:a}},c.axis.y2.tick={format:function(a){return"series"===c.chartGlobalType&&"category"!==c.axis.y2.type?c.axis.y2.prefix+a.toFixed(c.axis.y2.accuracy).toString()+c.axis.y2.suffix:a}},c.chartTitle="",c.chartCredit="",c.chartSource="",c.chartWidth=1e3,c.chartGlobalType="series",c.chartAccuracy=1,c.cms="undefined"!=typeof parent.tinymce?!0:!1,c.pie={label:{format:function(a,b){return(100*b).toFixed(c.chartAccuracy)+"%"}}},c.donut={label:{format:function(a,b){return(100*b).toFixed(c.chartAccuracy)+"%"}}},c.gauge={label:{format:function(a,b){return(100*b).toFixed(c.chartAccuracy)+"%"}}},{config:c,chartTypes:d,axesConfig:e,dependencies:this.getExternalDependencies()}},getExternalDependencies:function(){return{css:["//cdnjs.cloudflare.com/ajax/libs/c3/0.4.7/c3.min.css"],js:["//cdnjs.cloudflare.com/ajax/libs/d3/3.5.2/d3.min.js","//cdnjs.cloudflare.com/ajax/libs/c3/0.4.7/c3.min.js"]}}}}),angular.module("axisJSApp").controller("HeadCtrl",["configProvider","$scope",function(a,b){a.then(function(a){b.conf=a,b.stylesheet="undefined"!=typeof a.stylesheet?a.stylesheet:"",b.fonts="undefined"!=typeof a.fonts?a.fonts:[]})}]),angular.module("axisJSApp").service("inputService",["configProvider","$injector",function(a,b){return function(c,d){a.then(function(a){angular.forEach(a[d],function(a){var d=b.get(a+"Input");d.import(c)})})}}]),angular.module("axisJSApp").factory("csvService",function(){var a=42;return{someMethod:function(){return a}}}),angular.module("axisJSApp").factory("embedOutput",["GenericOutput","chartProvider","$modal",function(a,b,c){var d=angular.copy(a);return d.serviceConfig={type:"export",label:"Generate embed code"},d.preprocess=function(a){return a.config.bindto="#chart-"+Math.floor(6*Math.random()+1),{config:a.config,dependencies:b(a.appConfig).dependencies}},d.process=function(a){var b=[],c=String(angular.toJson(a.config));return b.push('<div id="'+a.config.bindto.replace("#","")+'"></div>'),angular.forEach(a.dependencies.css,function(a){b.push('<link rel="stylesheet" href="'+a+'" />')}),angular.forEach(a.dependencies.js,function(a){b.push('<script src="'+a+'"></script>')}),b.push('<script type="text/javascript">(function(){c3.generate('+c+");})();</script>"),b.join("\n")},d.complete=function(a){c.open({template:'<h1 style="text-align: center;">Embed code: <br /><small style="text-align: center;">Copy and paste this into a new HTML document</small></h1> <textarea width="100%" height="400" class="form-control">{{output}}</textarea>',controller:["$scope",function(b){b.output=a}]})},d}]),angular.module("axisJSApp").directive("maintainFocus",function(){return{restrict:"A",link:function(a,b){b.on("keydown",function(a){if(9===a.keyCode){var b=this.value,c=this.selectionStart,d=this.selectionEnd;return this.value=b.substring(0,c)+"	"+b.substring(d),this.selectionStart=this.selectionEnd=c+1,!1}})}}});